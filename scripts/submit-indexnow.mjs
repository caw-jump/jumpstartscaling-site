#!/usr/bin/env node
/**
 * Submit all sitemap URLs to IndexNow for fast indexing (Bing, Yandex, etc.).
 * Runs automatically after build (postbuild). Also: node scripts/submit-indexnow.mjs
 * Requires KEY at https://jumpstartscaling.com/jumpstart-indexnow-key-2026.txt
 */
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const SITE = 'https://jumpstartscaling.com';
const KEY = process.env.INDEXNOW_KEY || 'jumpstart-indexnow-key-2026';
const KEY_LOCATION = `${SITE}/jumpstart-indexnow-key-2026.txt`;

// Read URLs from sitemap (generated by build)
function getUrlsFromSitemap() {
  const distDir = join(__dirname, '../dist');
  const sitemapPath = join(distDir, 'sitemap-0.xml');
  try {
    const xml = readFileSync(sitemapPath, 'utf-8');
    const matches = xml.matchAll(/<loc>([^<]+)<\/loc>/g);
    return [...matches].map((m) => m[1]);
  } catch (e) {
    console.warn('Could not read sitemap, using fallback URL list:', e.message);
    return [SITE, `${SITE}/tools`];
  }
}

const urlList = getUrlsFromSitemap();

const payload = {
  host: 'jumpstartscaling.com',
  key: KEY,
  keyLocation: KEY_LOCATION,
  urlList,
};

const endpoints = [
  'https://api.indexnow.org/indexnow',
  'https://www.bing.com/indexnow',
  'https://yandex.com/indexnow',
];

async function submit() {
  console.log(`IndexNow: Submitting ${urlList.length} URLs to Bing, Yandex...`);
  for (const endpoint of endpoints) {
    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json; charset=utf-8' },
        body: JSON.stringify(payload),
      });
      const ok = res.status === 200 ? '✓' : '✗';
      console.log(`${ok} ${endpoint}: ${res.status} ${res.statusText}`);
      if (res.status !== 200) {
        const text = await res.text();
        if (text) console.log('  ', text.slice(0, 200));
      }
    } catch (e) {
      console.error(`✗ ${endpoint}: ${e.message}`);
    }
  }
}

submit();
