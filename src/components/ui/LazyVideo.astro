---
interface Props {
  src: string;
  poster?: string;
  ariaLabel?: string;
  class?: string;
}
const { src, poster = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 9'%3E%3Crect fill='%23050505' width='16' height='9'/%3E%3C/svg%3E", ariaLabel = "Video", class: className = "" } = Astro.props;
---

<div class:list={["rounded-2xl overflow-hidden aspect-video bg-black/20 relative", className]} data-video-wrapper>
  <video
    class="absolute inset-0 w-full h-full object-cover"
    loop
    muted
    playsinline
    preload="none"
    data-src={src}
    poster={poster}
    aria-label={ariaLabel}
  />
  <slot name="overlay" />
</div>

<script>
  document.querySelectorAll('[data-video-wrapper] video[data-src]').forEach((v) => {
    if (v.dataset.loaded) return;
    const io = new IntersectionObserver(
      (entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            const src = e.target.dataset.src;
            if (src) {
              e.target.src = src;
              e.target.load();
              e.target.removeAttribute('data-src');
              e.target.dataset.loaded = '1';
              e.target.play?.();
              io.unobserve(e.target);
            }
          }
        });
      },
      { rootMargin: '150px' }
    );
    io.observe(v);
  });
</script>
