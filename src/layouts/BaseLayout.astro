---
// src/layouts/BaseLayout.astro - Updated master layout (single source of truth for ALL pages)
import Navigation from '../components/ui/Navigation.astro';
import Footer from '../components/ui/Footer.astro';
import AtmosphereParticles from '../components/visuals/AtmosphereParticles.tsx';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  palette?: 'gold' | 'emerald' | 'sapphire';
  canonical?: string;
  ogImage?: string;
  crumbs?: { name: string; url: string }[];
  faqs?: { q: string; a: string }[];
  noindex?: boolean;
  fluid?: boolean;
}

const {
  title,
  description,
  palette = 'gold',
  canonical,
  ogImage = '/og-default.png',
  crumbs = [],
  faqs = [],
  noindex = false,
  fluid = false
} = Astro.props;

const siteUrl = 'https://jumpstartscaling.com';
const fullTitle = title === 'Jumpstart Scaling' ? title : `${title} | Jumpstart Scaling`;
const canonicalUrl = canonical ? new URL(canonical, siteUrl).href : new URL(Astro.url.pathname, siteUrl).href;
const ogImageUrl = ogImage.startsWith('http') ? ogImage : new URL(ogImage, siteUrl).href;

const org = {"@type":"Organization","name":"Jumpstart Scaling","url":siteUrl,"logo":`${siteUrl}/favicon.svg`,"description":"Growth engineering for companies serious about predictable revenue.","contactPoint":{"@type":"ContactPoint","contactType":"Sales","email":"hello@jumpstartscaling.com"}};
const webSite = {"@type":"WebSite","url":siteUrl,"name":"Jumpstart Scaling","potentialAction":{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":`${siteUrl}/search?q={search_term_string}`},"query-input":"required name=search_term_string"}};
const breadcrumb = crumbs.length > 0 ? {"@type":"BreadcrumbList","itemListElement":crumbs.map((c,i)=>({"@type":"ListItem","position":i+1,"name":c.name,"item":new URL(c.url,siteUrl).href}))} : null;
const faqSchema = faqs.length > 0 ? {"@type":"FAQPage","mainEntity":faqs.map(f=>({"@type":"Question","name":f.q,"acceptedAnswer":{"@type":"Answer","text":f.a}}))} : null;
const mainEntity = {"@type":"WebPage","name":title,"description":description,"url":canonicalUrl};

const graph = [org, webSite];
if (breadcrumb) graph.push(breadcrumb);
if (faqSchema) graph.push(faqSchema);
graph.push(mainEntity);

// Analytics â€“ set in Coolify env (PUBLIC_* = client-visible, no secrets)
const clarityId = import.meta.env.PUBLIC_CLARITY_ID || '';
const gaId = import.meta.env.PUBLIC_GA_ID || '';
---

<!DOCTYPE html>
<html lang="en" data-palette={palette}>
  <head>
    <!-- Default Meta -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#050505" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Per-Page Overrides via frontmatter -->
    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    {noindex ? <meta name="robots" content="noindex" /> : <meta name="robots" content="index,follow,max-image-preview:large" />}

    <!-- Open Graph / Twitter -->
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />

    <!-- Fonts - async load to avoid render blocking -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=JetBrains+Mono:wght@100..800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=JetBrains+Mono:wght@100..800&display=swap"></noscript>


    {clarityId && (
    <script type="text/javascript" define:vars={{ clarityId }}>
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", clarityId);
    </script>
    )}

    {gaId && (
    <>
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}></script>
    <script define:vars={{ gaId }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', gaId, { send_page_view: true, transport_type: 'beacon' });
    </script>
    </>
    )}

    <!-- Schema (Global Organization + WebSite + Breadcrumb) -->
    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@graph": [
            {
                "@type": "Organization",
                "@id": "https://jumpstartscaling.com/#organization",
                "name": "Jumpstart Scaling",
                "url": siteUrl,
                "logo": `${siteUrl}/favicon.svg`,
                "description": "Growth engineering for companies serious about predictable revenue.",
                "sameAs": [
                    "https://twitter.com/jumpstartscaling",
                    "https://linkedin.com/company/jumpstartscaling"
                ],
                "contactPoint": {
                    "@type": "ContactPoint",
                    "contactType": "Sales",
                    "email": "hello@jumpstartscaling.com"
                }
            },
            {
                "@type": "WebSite",
                "@id": "https://jumpstartscaling.com/#website",
                "url": siteUrl,
                "name": "Jumpstart Scaling",
                "publisher": { "@id": "https://jumpstartscaling.com/#organization" },
                "potentialAction": {
                    "@type": "SearchAction",
                    "target": `${siteUrl}/search?q={search_term_string}`,
                    "query-input": "required name=search_term_string"
                }
            },
            ...(graph.filter(g => g["@type"] !== "Organization" && g["@type"] !== "WebSite"))
        ]
    })} />

    <slot name="head" />
  </head>

  <body class="min-h-screen bg-bg-deep text-text-primary antialiased font-sans">
    
    <!-- Scroll Progress -->
    <div id="scroll-progress" class="fixed top-0 left-0 h-[3px] bg-gradient-to-r from-[#FFE5A0] to-[#E8C677] z-[100] w-0 transition-all duration-100 ease-out"></div>

    <Navigation currentPath={Astro.url.pathname} />

    <main class="relative z-10 pt-20">
        <!-- Breadcrumbs on subpages -->
        {crumbs.length > 0 && (
          <div class={fluid ? "w-full px-6" : "container mx-auto px-6"}>
            <nav aria-label="breadcrumb" class="py-8">
              <ol class="flex flex-wrap items-center gap-3 text-sm text-white/70">
                {crumbs.map((crumb, i) => (
                  <li class="flex items-center gap-3">
                    <a href={crumb.url} class="hover:text-accent transition">{crumb.name}</a>
                    {i < crumbs.length - 1 && <span class="text-white/30">/</span>}
                  </li>
                ))}
                <li class="text-white font-medium">{title}</li>
              </ol>
            </nav>
          </div>
        )}

        {/* Support fluid layouts for services/landing pages */}
        {fluid ? (
          <slot />
        ) : (
          <div class="container mx-auto px-6">
            <slot />
          </div>
        )}
    </main>

    <Footer />

    <!-- Particles Container -->
    <div class="particles fixed inset-0 pointer-events-none z-0 overflow-hidden"></div>

    <!-- Global Interaction Logic -->
    <script is:inline>
        // 1. SCROLL PROGRESS & NAV BLUR
        const progress = document.getElementById('scroll-progress');
        const nav = document.getElementById('navbar');
        
        function updateScroll() {
            // Navbar blur
            if (window.scrollY > 50) nav?.classList.add('nav-scrolled');
            else nav?.classList.remove('nav-scrolled');

            // Progress Bar
            if (progress) {
                const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrolled = (winScroll / height) * 100;
                progress.style.width = scrolled + "%";
            }
        }

        window.addEventListener('scroll', updateScroll, { passive: true });

        // 2. PARTICLES
        const particlesContainer = document.querySelector('.particles');
        if (particlesContainer && particlesContainer.children.length === 0) {
            for(let i=0; i<40; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.cssText = `
                    left: ${Math.random() * 100}%;
                    animation-delay: ${Math.random() * 5}s;
                    animation-duration: ${10 + Math.random() * 20}s;
                `;
                particlesContainer.appendChild(p);
            }
        }

        // 3. ANIMATION OBSERVER
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, { threshold: 0.1 });

        function observeAnimateElements() {
            document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
        }
        observeAnimateElements();
        document.addEventListener('astro:page-load', () => { updateScroll(); observeAnimateElements(); });
    </script>
  </body>
</html>
